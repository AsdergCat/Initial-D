@model IEnumerable<initial_d.Models.APIModels.Usuario>
@using initial_d.Common.FilterBar;

@{
    ViewBag.Title = "Admin. de Clientes";

    // To Keep an State on the Search Filters
    string userName = ViewBag.userName ?? string.Empty;
    string userRut = ViewBag.userRut ?? string.Empty;
    var userTypeList = (SelectList)ViewBag.userTypeLst;
    var userStatusList = (SelectList)ViewBag.userStatusLst;
    
    string banId = "BAN";

    // Action Url
    string addUrl = Url.Action("AddUser", "Usuarios");
    string delList = Url.Action("DeletedUserList", "Usuarios");
    // detailsUrl on HTML
}

<!-- HEADER | ACTION BUTTONS -->
<div class="header ">

    <div class="header-title">
        <h2>
            <i class="fa fa-users" aria-hidden="true"></i>
            Administrador de Usuarios
        </h2>
    </div>
    
    <!-- BUTTONS -->
    <div class="header-buttons">
        <a href="@delList" class="btn btn-sm btn-secondary" role="button">
            <i class="fa fa-trash" aria-hidden="true"></i>
            Usuarios Eliminados
        </a>
        @if (User.IsInRole("ADM") || User.IsInRole("TES"))
        {
            <a href="@addUrl" class="btn btn-sm btn-green ml-3" role="button">
                <i class="fa fa-user-plus"></i>
                Agregar Usuario
            </a>
        }
    </div>

</div>

<!-- BUSCAR -->
@{ 
    var filterTemplate = new FilterBarTemplate()
    {
        formAction = "UserList",
        formController = "Usuarios",
        filters = new List<MvcHtmlString>()
        {
            Html.TextBox("userName", userName, new { @class = "form-control form-control-sm h-100", @placeholder = "Nombre de Usuario" }),
            Html.TextBox("userRut", userRut, new { @class = "form-control form-control-sm h-100", @placeholder = "Rut" }),
            Html.DropDownList("userTypeId", userTypeList, "Tipo", new { @class = "custom-select custom-select-sm form-control" }),
            Html.DropDownList("userStatusId", userStatusList, "Status", new { @class = "custom-select custom-select-sm form-control" })
        }
    };
}
@Html.Partial("Partial/_FiltersCollapse", filterTemplate)

<!-- DATA TABLE -->
<div class=" d-flex justify-content-center ">
    <table class="table c-info-table c-table-sm-responsive c-table-bordered">

        <thead>
            <tr>
                <th>Actions</th>
                <th>@Html.DisplayNameFor(m => m.username)</th>
                <th class="cell-hidden-lg">@Html.DisplayNameFor(m => m.fullName)</th>
                <th>@Html.DisplayNameFor(m => m.rut)</th>
                <th>@Html.DisplayNameFor(m => m.user_type_id)</th>
                <th>@Html.DisplayNameFor(m => m.status_id)</th>
            </tr>
        </thead>

        <tbody>
            @* Print one row by User *@
            @foreach (var user in Model)
            {
                string detailsUrl = Url.Action("UserDetails", "Usuarios", new { userId = user.appuser_id });
                string userStatus = user.status_id;
                bool? isBanned = userStatus?.Equals(banId);

                <tr class="clickable-row" data-url="@detailsUrl">

                    <!-- ACTION DROPDOWN -->
                    <td data-label="Actions" class="not-clickable cell-compact-sm action-dw">
                        @Html.Partial("Partial/_ContextualActionDropdown", new ViewDataDictionary(user) { { "context", "list" } } )
                    </td>

                    <!-- USERNAME -->
                    <td data-label="@Html.DisplayNameFor(m => m.username)">
                        @if (isBanned != null)
                        {
                            var statClass = isBanned == true ? "fa-user-lock text-danger" : "fa-user-check color-green";
                            <div class="w-max-content-sm">
                                <i class=" fa mr-1 @statClass" aria-hidden="true"></i>
                                @Html.DisplayFor(m => user.username)
                            </div>
                        }
                    </td>

                    <!-- FULL NAME -->
                    <td data-label="@Html.DisplayNameFor(m => m.fullName)" class="cell-hidden-lg">
                        @Html.DisplayFor(m => user.fullName)
                    </td>

                    <!-- RUT -->
                    <td data-label="@Html.DisplayNameFor(m => m.rut)">
                        @Html.ValueFor(m => user.rut)
                    </td>

                    <!-- USER TYPE -->
                    <td data-label="@Html.DisplayNameFor(m => m.user_type_id)">
                        @Html.DisplayFor(m => user.user_type_name)
                    </td>

                    <!-- STATUS -->
                    <td data-label="@Html.DisplayNameFor(m => m.status_id)">
                        @Html.DisplayFor(m => user.status_name)
                    </td>
                </tr>
            }
        </tbody>

    </table>

</div>

<!-- MODALS -->
@Html.Partial("Partial/_ToggleUserStatusModal")
@Html.Partial("Partial/_DeleteModalAndScript")
@Html.Partial("Partial/_ChangeTypeModal")


@section customScripts{
    @Scripts.Render("~/Content/JS/c_table.js")
}